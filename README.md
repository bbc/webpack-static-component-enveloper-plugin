# Static Component Enveloper Plugin

This is a [webpack](https://webpack.js.org/) plugin that simplifies the creation of envelopes to serve your static components.
This plugin can automatically include your compiled CSS and JS files into the correct envelope sections.

## Installation
Run `npm install --save-dev @bbc/webpack-static-component-enveloper-plugin` to add this module to your project.

## Basic Usage
The plugin will generate envelopes that can include the assets generated by webpack. It uses [mustache](https://mustache.github.io/) 
templates to build the markup of the envelope elements and can embed the assets if special `inline` and `reference` tags are used. The `inline` tag will get the content of the asset and will replace with within the template, using the appropriate HTML tag. This will result in a larger envelope file but will reduce the number of requests the browser will make. The `reference` tag will create an HTML tag that will reference only reference the asset. This leads to a faster initial response but will require additional requests. 

## Example

```javascript
// webpack.config.json

const StaticComponentEnveloper = require('@bbc/webpack-static-component-enveloper-plugin');

module.exports = {
    ...
    plugins: [
        new StaticComponentEnveloper({
            name:       'my_static_component_envelope.json'
            head:       ['head.mustache'],
            bodyInline: ['bodyInline.mustache'],
            bodyLast:   ['bodyLast.mustache'],
            minify:     true,
        }),
    ]
};
```

```html
<!-- head.mustache -->

{{#inline}}my_static_component.css{{/inline}}
```

```html
<!-- bodyInline.mustache -->

<h1>My Static Component</h1>
```

```html
<!-- bodyLast.mustache -->

{{#reference}}my_static_component.js{{/reference}}
```

```json
// my_static_component_envelope.json

{
    "head": ["<style>h1 { color: red }</style>"],
    "bodyInline": "<h1>My Static Component</h1>",
    "bodyLast": ["<script type=\"text/javascript\" src=\"/my_static_component.js\"></script>"]
}
```

> Note: You can have more than one template per envelope element. In such a case, the plugin will concatenate the outputs according to the rules defined by the [envelope contract](https://confluence.dev.bbc.co.uk/display/mozart/Envelope+Format).

## Configuration
You can pass a hash of configuration options to StaticComponentEveloper. Allowed values are as follows:

| Value      | Type                  | Default | Use                                                                                  |
|------------|-----------------------|---------|--------------------------------------------------------------------------------------|
| name       | `String`              | `envelope.json` | The name of the envelope file that the plugin will generate.                 |
| head       | `Array<String>`       | []              | Array of mustache template paths comprising the envelope head element.       |
| bodyInline | `Array<String>`       | []              | Array of mustache template paths comprising the envelope bodyInline element. |
| bodyLast   | `Array<String>`       | []              | Array of mustache template paths comprising the envelope bldyLast element.   |
| minify     | `Boolean` \| `Object` | false           | Boolean value or [html-minifire options object](https://github.com/kangax/html-minifier#options-quick-reference). If `false` is passed the envelope won't be minified. If the value is `true` the plugin will use the default minification options*. If an object is passed the plugin will use it as minification object. |

\* Default minification options
```javascript
{
  collapseWhitespace: true,
  conservativeCollapse: true,
}
```

## Using the `publicPath` option

Webpack allows you to specify the `publicPath` which will be used when assets are generated. This option is passed as an attribute of the `output` object in the webpack config. This plugin will use the attribute when the `reference` tag is used. The value of the `publicPath` could be a string or a function.

If a string is passed it will be used as a prefix for the asset public paths for the reference tags.

```javascript
// webpack.config.js
...
  output: {
    ...
    publicPath: 'static_assets/'
  },
  plugins: [
    new StaticComponentEnveloper({
      head: ['template.mustache']
    })
  ]
...
```

```html
<!-- template.mustache -->

{{#reference}}style.css{{/reference}}
```

```json
// envelope.json

{
  "head": ["<link rel=\"stylesheet\" href=\"static_assets/style.css\" />"],
  ...
}
```

If a function is passed the plugin will execute it with the name of the asset as a parameter. The value that is returned will be used as a public path.


```javascript
// webpack.config.js
...
  output: {
    ...
    publicPath: assetName => (inDev ? 'http://localhost:8080/' : 'https://news.files.bbci.co.uk/') + assetName
  },
  plugins: [
    new StaticComponentEnveloper({
      head: ['template.mustache']
    })
  ]
...
```

```html
<!-- template.mustache -->

{{#reference}}style.css{{/reference}}
```

```json
// envelope.json

{
  "head": ["<link rel=\"stylesheet\" href=\"http://localhost:8080/style.css\" />"],
  ...
}
```
